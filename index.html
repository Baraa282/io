<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Pages Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f1e6e6;
            overflow: hidden;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .page-container {
            width: 100%;
            height: calc(100% - 50px);
            margin-top: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .page-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            transition: opacity 0.3s ease;
        }

        .ayah-overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ayah-highlight {
            position: absolute;
            background: transparent;
            border: none;
            pointer-events: all;
            cursor: pointer;
        }


        .loading {
            opacity: 0.5;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 24px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }

        .page-info {
            color: white;
            font-size: 16px;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .page-info:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .page-input {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #000;
            font-size: 16px;
            font-weight: 500;
            width: 60px;
            text-align: center;
            padding: 4px 8px;
            border-radius: 4px;
            outline: none;
        }

        .page-input:focus {
            background: white;
        }

        .go-button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s ease;
            touch-action: manipulation;
        }

        .go-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            touch-action: manipulation;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-button:active {
            background: rgba(255, 255, 255, 0.4);
        }

        .nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            transition: width 0.3s ease;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .controls {
                bottom: 10px;
                padding: 10px 16px;
                gap: 15px;
            }

            .page-info {
                font-size: 14px;
                min-width: 60px;
            }

            .page-input {
                font-size: 14px;
                width: 50px;
            }

            .go-button {
                padding: 5px 10px;
                font-size: 11px;
            }

            .nav-button {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .controls {
                bottom: 5px;
                padding: 8px 12px;
            }

            .page-info {
                font-size: 12px;
            }
        }

        /* Swipe indicator */
        .swipe-hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: center;
            z-index: 5;
            pointer-events: none;
        }

        @media (min-width: 769px) {
            .swipe-hint {
                display: none;
            }
        }

        /* Header Bar */
        .header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #f1e6e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 20;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .header-section.right {
            justify-content: flex-end;
        }

        .header-section.center {
            justify-content: center;
            flex: 0 0 auto;
        }

        .header-section.left {
            justify-content: flex-start;
            position: relative;
        }

        .header-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            direction: rtl;
            font-family: 'Arial', 'Tahoma', sans-serif;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .header-text:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .surah-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            min-width: 220px;
            margin-top: 5px;
            direction: rtl;
        }

        .surah-dropdown.active {
            display: block;
        }

        .surah-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            direction: rtl;
            text-align: right;
            transition: background 0.2s;
        }

        .surah-dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .surah-dropdown-item:last-child {
            border-bottom: none;
        }

        .surah-item-number {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }

        .surah-item-name {
            color: #333;
            font-weight: 500;
        }

        .header-number {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            direction: rtl;
            font-family: 'Arial', 'Tahoma', sans-serif;
        }

        .header-arrow {
            color: #333;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            padding: 5px 10px;
            transition: opacity 0.2s;
        }

        .header-arrow:hover {
            opacity: 0.7;
        }

        .header-arrow:active {
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header-bar {
                height: 45px;
                padding: 0 15px;
            }

            .page-container {
                height: calc(100% - 45px);
                margin-top: 45px;
            }

            .header-text {
                font-size: 14px;
            }

            .header-number {
                font-size: 16px;
            }

            .header-arrow {
                font-size: 18px;
                padding: 5px 8px;
            }

            .surah-dropdown {
                min-width: 180px;
                max-height: 300px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Header Bar -->
        <div class="header-bar">
            <div class="header-section left">
                <span class="header-text" id="surahName">سورة الفاتحة</span>
                <div class="surah-dropdown" id="surahDropdown"></div>
            </div>
            <div class="header-section center">
                <span class="header-number" id="pageNumberHeader">١</span>
            </div>
            <div class="header-section right">
                <span class="header-text" id="juzNumber">الجزء ١</span>
            </div>
        </div>
        
        <div class="swipe-hint"></div>
        <div class="progress-bar" id="progressBar"></div>
        <div class="page-container" id="pageContainer">
            <img id="pageImage" class="page-image" src="" alt="Page">
            <div class="ayah-overlay-container" id="ayahOverlayContainer"></div>
        </div>
    </div>

    <script src="quran-data.js"></script>
    <script>
        class QuranPageViewer {
            constructor() {
                this.currentPage = 1;
                this.totalPages = 604;
                this.touchStartX = 0;
                this.touchEndX = 0;
                this.minSwipeDistance = 50;
                this.isLoading = false;

                this.pageImage = document.getElementById('pageImage');
                this.progressBar = document.getElementById('progressBar');
                this.pageContainer = document.getElementById('pageContainer');
                this.surahName = document.getElementById('surahName');
                this.pageNumberHeader = document.getElementById('pageNumberHeader');
                this.juzNumber = document.getElementById('juzNumber');
                this.surahDropdown = document.getElementById('surahDropdown');
                this.ayahOverlayContainer = document.getElementById('ayahOverlayContainer');
                this.ayahPositions = null;
                this.currentAudio = null;

                this.init();
            }

            toEasternArabic(num) {
                const easternArabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                return num.toString().split('').map(digit => easternArabic[parseInt(digit)]).join('');
            }

            getSurahForPage(page) {
                if (page >= 1 && page <= 604 && QuranData.Page[page]) {
                    return QuranData.Page[page][0];
                }
                return 1;
            }

            getJuzForPage(page) {
                // Find which juz this page belongs to
                if (page >= 1 && page <= 604 && QuranData.Page[page]) {
                    const pageSurah = QuranData.Page[page][0];
                    const pageAyah = QuranData.Page[page][1];
                    
                    // Find the juz that contains this surah/ayah
                    for (let juz = 30; juz >= 1; juz--) {
                        if (QuranData.Juz[juz]) {
                            const juzSurah = QuranData.Juz[juz][0];
                            const juzAyah = QuranData.Juz[juz][1];
                            
                            if (pageSurah > juzSurah || 
                                (pageSurah === juzSurah && pageAyah >= juzAyah)) {
                                return juz;
                            }
                        }
                    }
                }
                return 1;
            }

            populateSurahDropdown() {
                if (!QuranData.Sura) return;

                this.surahDropdown.innerHTML = '';
                
                for (let i = 1; i <= 114; i++) {
                    if (QuranData.Sura[i]) {
                        const surahArabicName = QuranData.Sura[i][4];
                        const item = document.createElement('div');
                        item.className = 'surah-dropdown-item';
                        item.innerHTML = `
                            <span class="surah-item-name">${surahArabicName}</span>
                            <span class="surah-item-number">${this.toEasternArabic(i)}</span>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.goToSurah(i);
                            this.surahDropdown.classList.remove('active');
                        });
                        
                        this.surahDropdown.appendChild(item);
                    }
                }
            }

            goToSurah(surahNumber) {
                // Find the first page that contains this surah
                for (let page = 1; page <= 604; page++) {
                    if (QuranData.Page[page]) {
                        const pageSurah = QuranData.Page[page][0];
                        
                        // Check if this page starts with the surah
                        if (pageSurah === surahNumber) {
                            this.loadPage(page);
                            return;
                        }
                        
                        // Check if this page contains the surah (page starts with lower surah number)
                        // and next page starts with higher surah number or doesn't exist
                        if (pageSurah < surahNumber) {
                            const nextPage = page + 1;
                            if (nextPage > 604) {
                                // Last page - contains the surah
                                this.loadPage(page);
                                return;
                            }
                            
                            if (QuranData.Page[nextPage] && QuranData.Page[nextPage][0] > surahNumber) {
                                // Next page starts with higher surah, so current page contains our surah
                                this.loadPage(page);
                                return;
                            }
                        }
                    }
                }
                
                // Fallback: if not found, go to last page (for surah 114)
                if (surahNumber >= 112) {
                    this.loadPage(604);
                }
            }

            async loadAyahPositions() {
                try {
                    const response = await fetch('ayah_position.json');
                    const data = await response.json();
                    this.ayahPositions = data;
                } catch (error) {
                    console.error('Failed to load ayah positions:', error);
                    this.ayahPositions = null;
                }
            }

            createAyahOverlays() {
                // Clear existing overlays
                this.ayahOverlayContainer.innerHTML = '';

                // Find page data from array
                if (!this.ayahPositions || !Array.isArray(this.ayahPositions)) {
                    return;
                }

                const pageData = this.ayahPositions.find(p => p.page === this.currentPage);
                if (!pageData) {
                    return;
                }

                // Get surah number for current page
                const surahNumber = this.getSurahForPage(this.currentPage);

                // Wait for image to be fully rendered
                setTimeout(() => {
                    const imgRect = this.pageImage.getBoundingClientRect();
                    const containerRect = this.pageContainer.getBoundingClientRect();
                    
                    // Get actual image dimensions
                    const img = this.pageImage;
                    const naturalWidth = img.naturalWidth || img.width;
                    const naturalHeight = img.naturalHeight || img.height;
                    
                    // Reference image dimensions (from the JSON coordinates)
                    // Assuming the JSON coordinates are based on the original image size
                    const refWidth = naturalWidth;
                    const refHeight = naturalHeight;
                    
                    // Calculate scale factors based on displayed size vs natural size
                    const scaleX = imgRect.width / refWidth;
                    const scaleY = imgRect.height / refHeight;
                    
                    // Calculate offset (image is centered in container)
                    const offsetX = imgRect.left - containerRect.left;
                    const offsetY = imgRect.top - containerRect.top;

                    // Create overlays for each ayah
                    pageData.ayahs.forEach(ayah => {
                        ayah.parts.forEach((part, partIndex) => {
                            const overlay = document.createElement('div');
                            overlay.className = 'ayah-highlight';
                            
                            // Scale and position the overlay
                            overlay.style.left = `${offsetX + part.x * scaleX}px`;
                            overlay.style.top = `${offsetY + part.y * scaleY}px`;
                            overlay.style.width = `${part.w * scaleX}px`;
                            overlay.style.height = `${part.h * scaleY}px`;
                            
                            // Function to play audio
                            const playAudio = () => {
                                this.playAyahAudio(surahNumber, ayah.aya);
                            };
                            
                            // Add click handler for desktop
                            overlay.addEventListener('click', playAudio);
                            
                            // Add touch handlers for mobile
                            let touchStartTime = 0;
                            let touchStartY = 0;
                            
                            overlay.addEventListener('touchstart', (e) => {
                                touchStartTime = Date.now();
                                touchStartY = e.touches[0].clientY;
                                // Prevent swipe navigation when touching an ayah
                                e.stopPropagation();
                            }, { passive: true });
                            
                            overlay.addEventListener('touchend', (e) => {
                                const touchEndTime = Date.now();
                                const touchDuration = touchEndTime - touchStartTime;
                                const touchEndY = e.changedTouches[0].clientY;
                                const verticalMovement = Math.abs(touchEndY - touchStartY);
                                
                                // Only play audio if it was a quick tap (not a swipe)
                                // and vertical movement is minimal (to distinguish from scroll)
                                if (touchDuration < 300 && verticalMovement < 10) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    playAudio();
                                }
                            }, { passive: false });
                            
                            this.ayahOverlayContainer.appendChild(overlay);
                        });
                    });
                }, 100);
            }

            playAyahAudio(surahNumber, ayahNumber) {
                // Stop any currently playing audio
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio = null;
                }

                // Play audio from EveryAyah.com API - Alafasy recitation
                const audioUrl = `https://everyayah.com/data/Alafasy_128kbps/${String(surahNumber).padStart(3, '0')}${String(ayahNumber).padStart(3, '0')}.mp3`;
                
                this.currentAudio = new Audio(audioUrl);
                this.currentAudio.play().catch(error => {
                    console.error('Failed to play audio:', error);
                });
            }

            updateHeader() {
                const surahNum = this.getSurahForPage(this.currentPage);
                const juzNum = this.getJuzForPage(this.currentPage);
                
                // Get surah name in Arabic
                if (QuranData.Sura && QuranData.Sura[surahNum]) {
                    const surahArabicName = QuranData.Sura[surahNum][4];
                    this.surahName.textContent = `سورة ${surahArabicName}`;
                }
                
                // Update page number in Eastern Arabic
                this.pageNumberHeader.textContent = this.toEasternArabic(this.currentPage);
                
                // Update juz number in Eastern Arabic
                this.juzNumber.textContent = `الجزء ${this.toEasternArabic(juzNum)}`;
            }

            async init() {
                await this.loadAyahPositions();
                this.populateSurahDropdown();
                this.loadPage(this.currentPage);

                // Surah name click to show dropdown
                this.surahName.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.surahDropdown.classList.toggle('active');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.surahName.contains(e.target) && !this.surahDropdown.contains(e.target)) {
                        this.surahDropdown.classList.remove('active');
                    }
                });

                // Recalculate overlay positions on window resize
                window.addEventListener('resize', () => {
                    if (this.currentPage === 1) {
                        this.createAyahOverlays();
                    }
                });

                // Touch events for swiping
                this.pageContainer.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
                this.pageContainer.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        this.goToPreviousPage();
                    } else if (e.key === 'ArrowRight') {
                        this.goToNextPage();
                    }
                });

                // Mouse drag support (for desktop)
                let isDragging = false;
                let startX = 0;

                this.pageContainer.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX;
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                });

                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    const diffX = startX - e.clientX;
                    if (Math.abs(diffX) > this.minSwipeDistance) {
                        if (diffX < 0) {
                            // Drag right - go forward (1->2->3...)
                            this.goToNextPage();
                        } else {
                            // Drag left - go backward (1->604->603...)
                            this.goToPreviousPage();
                        }
                    }
                });

                this.updateProgress();
            }

            handleTouchStart(e) {
                // Check if touch started on an ayah overlay
                const target = e.target;
                if (target && target.classList.contains('ayah-highlight')) {
                    // Don't track swipe if touching an ayah
                    this.touchStartX = null;
                    return;
                }
                this.touchStartX = e.changedTouches[0].screenX;
            }

            handleTouchEnd(e) {
                // Check if touch ended on an ayah overlay
                const target = e.target;
                if (target && target.classList.contains('ayah-highlight')) {
                    // Don't trigger swipe if touching an ayah
                    return;
                }
                
                if (this.touchStartX === null) {
                    return;
                }
                
                this.touchEndX = e.changedTouches[0].screenX;
                this.handleSwipe();
            }

            handleSwipe() {
                const swipeDistance = this.touchStartX - this.touchEndX;

                if (Math.abs(swipeDistance) > this.minSwipeDistance) {
                    if (swipeDistance < 0) {
                        // Swipe right - go forward (1->2->3...)
                        this.goToNextPage();
                    } else {
                        // Swipe left - go backward (1->604->603...)
                        this.goToPreviousPage();
                    }
                }
            }

            loadPage(pageNumber) {
                if (this.isLoading || pageNumber < 1 || pageNumber > this.totalPages) {
                    return;
                }

                this.isLoading = true;
                this.pageImage.classList.add('loading');

                const imagePath = `quran-images/${pageNumber}.png`;
                const img = new Image();

                img.onload = () => {
                    this.pageImage.src = imagePath;
                    this.pageImage.classList.remove('loading');
                    this.currentPage = pageNumber;
                    this.updateHeader();
                    this.updateProgress();
                    this.createAyahOverlays();
                    this.isLoading = false;
                };

                img.onerror = () => {
                    console.error(`Failed to load page ${pageNumber}`);
                    this.pageImage.classList.remove('loading');
                    this.isLoading = false;
                };

                img.src = imagePath;
            }

            goToNextPage() {
                if (this.isLoading) return;
                if (this.currentPage < this.totalPages) {
                    this.loadPage(this.currentPage + 1);
                } else {
                    // Wrap around: from 604 to 1
                    this.loadPage(1);
                }
            }

            goToPreviousPage() {
                if (this.isLoading) return;
                if (this.currentPage > 1) {
                    this.loadPage(this.currentPage - 1);
                } else {
                    // Wrap around: from 1 to 604
                    this.loadPage(this.totalPages);
                }
            }

            updateProgress() {
                const progress = (this.currentPage / this.totalPages) * 100;
                this.progressBar.style.width = `${progress}%`;
            }
        }

        // Initialize the viewer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new QuranPageViewer();
        });
    </script>
</body>
</html>

